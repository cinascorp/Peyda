<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UAV</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.34/"></script>
  <style>
    html, body, #viewDiv {
      padding: 0; margin: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif; direction: rtl;
    }
    .esri-popup__content {
      font-size: 8px; line-height: 1.4; text-align: right;
    }

    .flightradar-link {
      color: blue; text-decoration: underline; cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/widgets/BasemapToggle"
    ], 
    
    function(Map, MapView, Graphic, GraphicsLayer, BasemapToggle) {
      const map = new Map({ basemap: "streets-vector" });
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [53, 30],
        zoom: 8
      });
      const basemapToggle = new BasemapToggle({
        view: view,
        nextBasemap: "satellite"
      });
      view.ui.add(basemapToggle, "top-right");
      const droneLayer = new GraphicsLayer();
      const militaryLayer = new GraphicsLayer();
      const civilianLayer = new GraphicsLayer();
      map.addMany([civilianLayer, militaryLayer, droneLayer]);
      let isFirstLoad = true;
      async function fetchAdsbData() {
        try {
          const response = await fetch('https://api.adsb.lol/v2/mil', {
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
              'Accept': 'application/json',
              'Origin': window.location.origin
            }
          });
          const text = await response.text();
          const cleanedText = text.replace(/^while\(1\);/, '').trim();
          const data = JSON.parse(cleanedText);
          return Array.isArray(data) ? data : data.aircraft || data.ac || [];
        } catch (error) {
          return [];
        }
      }
      async function fetchFlightradarData() {
        try {
          const response = await fetch('https://data-cloud.flightradar24.com/zones/fcgi/feeds.js', {
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
              'Accept': 'application/json'
            }
          });
          const text = await response.text();
          const cleanedText = text.replace(/^while\(1\);/, '').trim();
          const data = JSON.parse(cleanedText);
          const flights = [];
          for (const [key, value] of Object.entries(data)) {
            if (!Array.isArray(value)) continue;
            flights.push({
              id: key,
              lat: value[1],
              lon: value[2],
              track: value[3] || 0,
              alt_baro: value[4] || 'نامشخص',
              gs: value[5] || 'نامشخص',
              flight: value[13] || 'نامشخص',
              hex: value[0] || 'نامشخص',
              type: 'civilian',
              model: value[8] || 'نامشخص',
              r: value[9] || 'نامشخص',
              category: value[11] || 'نامشخص'
            });
          }
          return flights;
        } catch (error) {
          return [];
        }
      }
      async function fetchOpenSkyData() {
        try {
          const response = await fetch('https://opensky-network.org/api/states/all', {
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
              'Accept': 'application/json'
            }
          });
          const data = await response.json();
          return (data.states || []).map(flight => ({
            icao24: flight[0],
            callsign: flight[1]?.trim() || 'نامشخص',
            lon: flight[5],
            lat: flight[6],
            alt_baro: flight[7] || 'نامشخص',
            velocity: flight[9] || 'نامشخص',
            heading: flight[10] || 0,
            type: 'aircraft',
            hex: flight[0] || 'نامشخص',
            squawk: flight[14] || 'نامشخص',
            emergency: flight[15] || 'نامشخص',
            baro_rate: flight[11] || 'نامشخص',
            alt_geom: flight[13] || 'نامشخص',
            nav_modes: flight[16] || [],
            nac_p: flight[17] || 'نامشخص',
            nac_v: flight[18] || 'نامشخص',
            sil: flight[19] || 'نامشخص',
            sil_type: flight[20] || 'نامشخص',
            gva: flight[21] || 'نامشخص',
            sda: flight[22] || 'نامشخص',
            alert: flight[23] || 'نامشخص',
            spi: flight[24] || 'نامشخص'
          }));
        } catch (error) {
          return [];
        }
      }
      
      function getSampleDroneData() {
      return [];
       }
      function identifyFlightType(flight) {
        if ((flight.gs < 100 || flight.velocity < 100) || flight.alt_baro < 5000 ||
            ['DJI', 'Mq', 'Bayraktar', 'Mavic','shahed'].some(model => flight.model?.includes(model) || flight.t?.includes(model))) {
          return 'drone';
        }
        if (!flight.callsign && !flight.flight || flight.callsign === 'نامشخص' && flight.flight === 'نامشخص') {
          return 'unknown';
        }
        if (flight.type === 'military' && ['Eurofighter', 'F-16', 'F-35', 'F-22', 'Su-27', 'MiG-29'].some(model => flight.t?.includes(model) || flight.model?.includes(model))) {
          return 'fighter';
        }
        if (flight.category?.includes('Naval') || flight.t?.includes('P-8') || flight.t?.includes('Poseidon')) {
          return 'navy';
        }
        if (flight.hex?.startsWith('7B') || flight.r?.startsWith('EP-')) {
          return 'iranian';
        }
        return flight.type === 'military' ? 'military' : 'civilian';
      }
      function getFlightColor(flight) {
        const flightType = identifyFlightType(flight);
        switch (flightType) {
          case 'drone': return 'black';
          case 'unknown': return 'yellow';
          case 'fighter': return 'orange';
          case 'navy': return 'lightblue';
          case 'iranian': return 'green';
          case 'military': return 'red';
          default: return 'blue';
        }
      }
      function getIconSize(zoom) {
        if (zoom >= 11) return "8px";
        if (zoom >= 8) return "16px";
        if (zoom >= 6) return "24px";
        if (zoom >= 3) return "32px";
        return "15px";
      }
      function createMilitaryPopupContent(flight) {
        const flightradarLink = flight.hex && flight.flight !== 'نامشخص' ? 
          `<a class="flightradar-link" href="https://www.flightradar24.com/${flight.hex}/${flight.flight}/3d" target="_blank">نمایش ۳بعدی مسیر</a>` : '';
        return `
          <b>نوع منبع داده: </b>${flight.type || 'نامشخص'}<br>
          <b>شناسه هگزا: </b>${flight.hex || 'نامشخص'}<br>
          <b>شناسه پرواز: </b>${flight.flight || flight.callsign || 'نامشخص'}<br>
          <b>شماره ثبت: </b>${flight.r || 'نامشخص'}<br>
          <b>نوع هواپیما: </b>${flight.t || flight.model || 'نامشخص'}<br>
          <b>پرچم پایگاه داده: </b>${flight.db_flags || 'نامشخص'}<br>
          <b>ارتفاع بارومتریک (فوت): </b>${flight.alt_baro || 'نامشخص'}<br>
          <b>ارتفاع هندسی (فوت): </b>${flight.alt_geom || 'نامشخص'}<br>
          <b>سرعت زمینی (گره): </b>${flight.gs || flight.velocity || 'نامشخص'}<br>
          <b>جهت حرکت (درجه): </b>${flight.track || flight.heading || 'نامشخص'}<br>
          <b>نرخ صعود/کاهش (فوت/دقیقه): </b>${flight.baro_rate || 'نامشخص'}<br>
          <b>کد اسکواک: </b>${flight.squawk || 'نامشخص'}<br>
          <b>وضعیت اضطراری: </b>${flight.emergency || 'نامشخص'}<br>
          <b>دسته‌بندی: </b>${flight.category || 'نامشخص'}<br>
          <b>عرض جغرافیایی: </b>${flight.lat || 'نامشخص'}<br>
          <b>طول جغرافیایی: </b>${flight.lon || 'نامشخص'}<br>
          <b>یکپارچگی ناوبری (NIC): </b>${flight.nic || 'نامشخص'}<br>
          <b>شعاع محصور (متر): </b>${flight.rc || 'نامشخص'}<br>
          <b>زمان آخرین به‌روزرسانی (ثانیه): </b>${flight.seen_pos || 'نامشخص'}<br>
          <b>نسخه ADS-B: </b>${flight.version || 'نامشخص'}<br>
          <b>یکپارچگی ناوبری ارتفاع (NIC_BARO): </b>${flight.nic_baro || 'نامشخص'}<br>
          <b>دقت ناوبری موقعیت (NAC_P): </b>${flight.nac_p || 'نامشخص'}<br>
          <b>دقت ناوبری سرعت (NAC_V): </b>${flight.nac_v || 'نامشخص'}<br>
          <b>سطح یکپارچگی سیستم (SIL): </b>${flight.sil || 'نامشخص'}<br>
          <b>نوع SIL: </b>${flight.sil_type || 'نامشخص'}<br>
          <b>دقت عمودی هندسی (GVA): </b>${flight.gva || 'نامشخص'}<br>
          <b>اطمینان طراحی سیستم (SDA): </b>${flight.sda || 'نامشخص'}<br>
          <b>هشدار: </b>${flight.alert || 'نامشخص'}<br>
          <b>شناسایی موقعیت ویژه (SPI): </b>${flight.spi || 'نامشخص'}<br>
          <b>داده‌های MLAT: </b>${flight.mlat?.length ? flight.mlat.join(', ') : 'خالی'}<br>
          <b>داده‌های TIS-B: </b>${flight.tisb?.length ? flight.tisb.join(', ') : 'خالی'}<br>
          <b>تعداد پیام‌ها: </b>${flight.messages || 'نامشخص'}<br>
          <b>زمان آخرین پیام (ثانیه): </b>${flight.seen || 'نامشخص'}<br>
          <b>قدرت سیگنال (dB): </b>${flight.rssi || 'نامشخص'}<br>
          ${flightradarLink}
        `;
      }
      function createCivilianPopupContent(flight) {
        const flightradarLink = flight.hex && flight.flight !== 'نامشخص' ? 
          `<a class="flightradar-link" href="https:www.//flightradar24.com/${flight.flight}/${flight.hex}/3d" target="_blank">نمایش سه بعدی و مسیر</a>` : '';
        return `
          <b>نوع منبع داده: </b>${flight.type || 'نامشخص'}<br>
          <b>شناسه هگزا: </b>${flight.hex || 'نامشخص'}<br>
          <b>شناسه پرواز: </b>${flight.flight || flight.callsign || 'نامشخص'}<br>
          <b>شماره ثبت: </b>${flight.r || 'نامشخص'}<br>
          <b>نوع هواپیما: </b>${flight.model || 'نامشخص'}<br>
          <b>ارتفاع بارومتریک (فوت): </b>${flight.alt_baro || 'نامشخص'}<br>
          <b>ارتفاع هندسی (فوت): </b>${flight.alt_geom || 'نامشخص'}<br>
          <b>سرعت زمینی (گره): </b>${flight.gs || flight.velocity || 'نامشخص'}<br>
          <b>جهت حرکت (درجه): </b>${flight.track || flight.heading || 'نامشخص'}<br>
          <b>نرخ صعود/کاهش (فوت/دقیقه): </b>${flight.baro_rate || 'نامشخص'}<br>
          <b>کد اسکواک: </b>${flight.squawk || 'نامشخص'}<br>
          <b>وضعیت اضطراری: </b>${flight.emergency || 'نامشخص'}<br>
          <b>دسته‌بندی: </b>${flight.category || 'نامشخص'}<br>
          <b>عرض جغرافیایی: </b>${flight.lat || 'نامشخص'}<br>
          <b>طول جغرافیایی: </b>${flight.lon || 'نامشخص'}<br>
          <b>یکپارچگی ناوبری (NIC): </b>${flight.nic || 'نامشخص'}<br>
          <b>شعاع محصور (متر): </b>${flight.rc || 'نامشخص'}<br>
          <b>زمان آخرین به‌روزرسانی (ثانیه): </b>${flight.seen_pos || 'نامشخص'}<br>
          <b>نسخه ADS-B: </b>${flight.version || 'نامشخص'}<br>
          <b>یکپارچگی ناوبری ارتفاع (NIC_BARO): </b>${flight.nic_baro || 'نامشخص'}<br>
          <b>دقت ناوبری موقعیت (NAC_P): </b>${flight.nac_p || 'نامشخص'}<br>
          <b>دقت ناوبری سرعت (NAC_V): </b>${flight.nac_v || 'نامشخص'}<br>
          <b>سطح یکپارچگی سیستم (SIL): </b>${flight.sil || 'نامشخص'}<br>
          <b>نوع SIL: </b>${flight.sil_type || 'نامشخص'}<br>
          <b>دقت عمودی هندسی (GVA): </b>${flight.gva || 'نامشخص'}<br>
          <b>اطمینان طراحی سیستم (SDA): </b>${flight.sda || 'نامشخص'}<br>
          <b>هشدار: </b>${flight.alert || 'نامشخص'}<br>
          <b>شناسایی موقعیت ویژه (SPI): </b>${flight.spi || 'نامشخص'}<br>
          <b>داده‌های MLAT: </b>${flight.mlat?.length ? flight.mlat.join(', ') : 'خالی'}<br>
          <b>داده‌های TIS-B: </b>${flight.tisb?.length ? flight.tisb.join(', ') : 'خالی'}<br>
          <b>تعداد پیام‌ها: </b>${flight.messages || 'نامشخص'}<br>
          <b>زمان آخرین پیام (ثانیه): </b>${flight.seen || 'نامشخص'}<br>
          <b>قدرت سیگنال (dB): </b>${flight.rssi || 'نامشخص'}<br>
          ${flightradarLink}
        `;
      }
      function createDronePopupContent(drone) {
        return `
          <b>نوع منبع داده: </b>${drone.type || 'نامشخص'}<br>
          <b>شناسه پهپاد: </b>${drone.id || 'نامشخص'}<br>
          <b>مدل: </b>${drone.model || 'نامشخص'}<br>
          <b>عرض جغرافیایی: </b>${drone.lat || 'نامشخص'}<br>
          <b>طول جغرافیایی: </b>${drone.lon || 'نامشخص'}<br>
          <b>ارتفاع بارومتریک (فوت): </b>${drone.alt_baro || 'نامشخص'}<br>
          <b>سرعت زمینی (گره): </b>${drone.velocity || 'نامشخص'}<br>
          <b>جهت حرکت (درجه): </b>${drone.heading || 'نامشخص'}<br>
          <b>نوع: </b>پهپاد<br>
        `;
      }
      async function updateMarkers() {
        const adsbFlights = await fetchAdsbData();
        const flightradarFlights = await fetchFlightradarData();
        const openSkyFlights = await fetchOpenSkyData();
        const droneData = getSampleDroneData();
        const allFlights = [...adsbFlights.map(f => ({ ...f, type: 'military' })), ...flightradarFlights, ...openSkyFlights, ...droneData];
        civilianLayer.removeAll();
        militaryLayer.removeAll();
        droneLayer.removeAll();
        const iconSize = getIconSize(view.zoom);
        allFlights.forEach(flight => {
          if (flight.lat && flight.lon) {
            const flightType = identifyFlightType(flight);
            const layer = flightType === 'drone' ? droneLayer : 
                         (flightType === 'military' || flightType === 'fighter' || flightType === 'navy' || flightType === 'iranian') ? militaryLayer : 
                         civilianLayer;
            const graphic = new Graphic({
              geometry: {
                type: "point",
                latitude: flight.lat,
                longitude: flight.lon
              },
              symbol: {
                type: "picture-marker",
                url: flightType === 'drone' ? "https://img.icons8.com/ios/40/drone-bottom-view.png" :
                     flightType === 'unknown' ? "https://www.iconsdb.com/icons/preview/yellow/airplane-3-xl.png" :
                     flightType === 'fighter' ? "https://www.iconsdb.com/icons/preview/orange/airplane-3-xl.png" :
                     flightType === 'navy' ? "https://www.iconsdb.com/icons/preview/orange/airplane-3-xl.png" :
                     flightType === 'iranian' ? "https://www.iconsdb.com/icons/preview/green/airplane-3-xl.png" :
                     flightType === 'military' ? "https://www.iconsdb.com/icons/preview/red/airplane-3-xl.png" :
                     "https://img.icons8.com/external-soft-fill-juicy-fish/60/external-airplane-internet-of-things-soft-fill-soft-fill-juicy-fish.png",
                width: iconSize,
                height: iconSize,
                angle: flight.track || flight.heading || 0
              },
              attributes: flight,
              popupTemplate: {
                title: flightType === 'drone' ? "پهپاد" :
                       flightType === 'unknown' ? "شیء ناشناس" :
                       flightType === 'fighter' ? "جنگنده نظامی" :
                       flightType === 'navy' ? "هواپیمای نیروی دریایی" :
                       flightType === 'iranian' ? "هواپیمای ایرانی" :
                       flightType === 'military' ? "پرواز نظامی" : "پرواز غیرنظامی",
                content: flightType === 'drone' ? createDronePopupContent(flight) :
                         (flightType === 'military' || flightType === 'fighter' || flightType === 'navy' || flightType === 'iranian') ? createMilitaryPopupContent(flight) :
                         createCivilianPopupContent(flight)
              }
            });
            layer.add(graphic);
          }
        });
        if (isFirstLoad && allFlights.length > 0) {
          const bounds = allFlights.filter(f => f.lat && f.lon).map(f => [f.lat, f.lon]);
          if (bounds.length > 0) {
            view.goTo({ target: bounds });
            isFirstLoad = false;
          }
        }
      }
      view.watch("zoom", () => {
        const iconSize = getIconSize(view.zoom);
        [civilianLayer, militaryLayer, droneLayer].forEach(layer => {
          layer.graphics.forEach(graphic => {
            graphic.symbol.width = iconSize;
            graphic.symbol.height = iconSize;
          });
        });
      });
      updateMarkers();
      setInterval(updateMarkers, 15000);
    });
  </script>
</body>
</html>