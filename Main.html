<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3d</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="viewDiv"></div>
    <script>
        require([
            "esri/WebScene",
            "esri/views/SceneView",
            "esri/layers/FeatureLayer",
            "esri/Graphic",
            "esri/geometry/Point",
            "esri/symbols/PictureMarkerSymbol"
        ], function(WebScene, SceneView, FeatureLayer, Graphic, Point, PictureMarkerSymbol) {
            const webscene = new WebScene({
                portalItem: {
                    id: "6682f70b89c4483f88e8df839a011c1e"
                }
            })
            const view = new SceneView({
                container: "viewDiv",
                map: webscene,
                ui: { components: ["zoom"] } 
            });
            const commercialIcon = new PictureMarkerSymbol({
                url: "https://static.arcgis.com/images/Symbols/Transportation/Airplane.png",
                width: "20px",
                height: "20px"
            });
            const militaryIcon = new PictureMarkerSymbol({
                url: "https://static.arcgis.com/images/Symbols/Transportation/Helicopter.png",
                width: "20px",
                height: "20px"
            });
            const droneIcon = new PictureMarkerSymbol({
                url: "https://example.com/drone-icon.png", 
                width: "15px",
                height: "15px"
            });
            function getCategoryAndStyle(callsign, altitude, velocity) {
                let category = "commercial";
                let color = "#0000FF"; // آبی
                let icon = commercialIcon;

                if (callsign && (callsign.includes("NATO") || callsign.includes("AF") || callsign.includes("MIL"))) {
                    category = "military";
                    color = "#FF0000"; // قرمز
                    icon = militaryIcon;
                } else if (altitude < 1000 && velocity < 50) {
                    category = "drone";
                    color = "#00FF00"; // سبز
                    icon = droneIcon;
                }
                return { category, color, icon };
            }
            async function fetchFlights() {
                try {
                    const response = await fetch("http://localhost:3000/proxy");
                    const data = await response.json();
                    const states = data.states || [];

                    const graphics = states
                        .filter(state => state[5] !== null && state[6] !== null)
                        .map(state => {
                            const lon = parseFloat(state[5]);
                            const lat = parseFloat(state[6]);
                            const callsign = state[1] ? state[1].trim() : "Unknown";
                            const altitude = state[7] || 0;
                            const velocity = state[9] || 0;
                            const { category, color, icon } = getCategoryAndStyle(callsign, altitude, velocity);
                            return new Graphic({
                                geometry: new Point({
                                    longitude: lon,
                                    latitude: lat
                                }),
                                attributes: {
                                    callsign: callsign,
                                    category: category,
                                    altitude: altitude,
                                    velocity: velocity
                                },
                                symbol: icon
                            });
                        });
                    const flightLayer = new FeatureLayer({
                        source: graphics,
                        objectIdField: "callsign",
                        fields: [
                            { name: "callsign", type: "string" },
                            { name: "category", type: "string" },
                            { name: "altitude", type: "double" },
                            { name: "velocity", type: "double" }
                        ],
                        popupTemplate: {
                            title: "{callsign}",
                            content: "Category: {category}<br>Altitude: {altitude} m<br>Velocity: {velocity} m/s"
                        },
                        renderer: {
                            type: "unique-value",
                            field: "category",
                            uniqueValueInfos: [
                                {
                                    value: "commercial",
                                    symbol: commercialIcon
                                },
                                {
                                    value: "military",
                                    symbol: militaryIcon
                                },
                                {
                                    value: "drone",
                                    symbol: droneIcon
                                }
                            ]
                        }
                    });
                    webscene.removeAll();
                    webscene.add(flightLayer);
                    console.log(`تعداد پروازها: ${graphics.length}`);
                } catch (error) {
                    console.error("خطا در fetch پروازها:", error);
                }
            }
            fetchFlights();
            setInterval(fetchFlights, 15000);
        });
    </script>
</body>
</html>
